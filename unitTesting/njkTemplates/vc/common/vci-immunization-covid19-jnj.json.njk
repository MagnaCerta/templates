{# based on: http://build.fhir.org/ig/dvci/vaccine-credential-ig/branches/main/StructureDefinition-vaccination-credential-immunization-examples.html #}
{
  "@context": [
    "https://www.w3.org/2018/credentials/v1",
    "https://schema.opencerta.org/proof",
    "https://schema.opencerta.org/fhir/202009"
  ],
  "type": ["VerifiableCredential", "FHIRCredential"],
  "id": "urn:uuid:{{ credential.id }}",
  "issuer": "https://issuers.{{baseUrl}}/{{certificate.authorityKeyIdentifier | trim}}/{{certificate.subjectKeyIdentifier | trim }}",
  "credentialSubject": {
    "type": "FHIRCredential",
    "id": "urn:uuid:{{ subject.id }}",
    "givenName": "{{ subject.formData.givenName | trim }}",
    {% if subject.formData.middleName and (subject.formData.middleName | trim) %}
    "additionalName": "{{ subject.formData.middleName | trim }}",
    {% endif -%}
    "familyName": "{{ subject.formData.familyName | trim }}",
    {% if subject.formData.birthDate %}
    "birthDate": "{{ subject.formData.birthDate | date('yyyy-MM-DD') }}",
    {% endif -%}
    {% if subject.formData.gender and (subject.formData.gender | trim) %}
    "gender": "{{ subject.formData.gender | trim }}",
    {% endif -%}
    {% if subject.formData.honorificPrefix and (subject.formData.honorificPrefix | trim) %}
    "honorificPrefix": "{{ subject.formData.honorificPrefix | trim }}",
    {% endif -%}
    {% if subject.formData.honorificSuffix and (subject.formData.honorificSuffix | trim) %}
    "honorificSuffix": "{{ subject.formData.honorificSuffix | trim }}",
    {% endif -%}
    {% if subject.formData.externalReference and (subject.formData.externalReference | trim) %}
    "identifier": {
      "@type": "PropertyValue",
      "propertyID": "External Reference",
      "value":  "{{subject.formData.externalReference | trim}}"
    },
    {% endif -%}
    "fhirVersion": "4.0.1",
    "fhirSource": {
        "resourceType": "Bundle",
        "id": "https://creds.magnacerta.com/{{ credential.id }}/bundle",
        "type": "collection",
        "entry": [
            {
                "fullUrl": "https://creds.magnacerta.com/{{ credential.id }}/bundle/resource/0",
                "resource": {
                    "resourceType": "Patient",
                    {% if (subject.formData.passportNumber and (subject.formData.passportNumber | trim)) and (subject.formData.driversLicense and (subject.formData.driversLicense | trim)) %}
                    "identifier" : [
                        {
                        {% if subject.formData.citizenshipCountry and (subject.formData.citizenshipCountry | trim) %}
                        "extension" : [{
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166",
                                "code" : "{{ subject.formData.citizenshipCountry | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% if subject.formData.citizenshipState and (subject.formData.citizenshipState | trim) %}
                        ,
                        {
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166:-2",
                                "code" : "{{ subject.formData.citizenshipState | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% endif -%}
                        ],
                        {% endif -%}
                        "type": {
                            "coding": {
                            "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                            "code": "PPN"
                            }
                        },
                        "value": "{{ subject.formData.passportNumber | trim }}"
                        },
                        {
                        {% if subject.formData.citizenshipCountry and (subject.formData.citizenshipCountry | trim) %}
                        "extension" : [{
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166",
                                "code" : "{{ subject.formData.citizenshipCountry | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% if subject.formData.citizenshipState and (subject.formData.citizenshipState | trim) %}
                        ,
                        {
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166:-2",
                                "code" : "{{ subject.formData.citizenshipState | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% endif -%}
                        ],
                        {% endif -%}
                        "type": {
                            "coding": {
                            "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                            "code": "DL"
                            }
                        },
                        "value": "{{ subject.formData.driversLicense | trim }}"
                        }
                    ],
                    {% elif subject.formData.passportNumber and (subject.formData.passportNumber | trim) %}
                    "identifier" : [
                        {
                        {% if subject.formData.citizenshipCountry and (subject.formData.citizenshipCountry | trim) %}
                        "extension" : [{
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166",
                                "code" : "{{ subject.formData.citizenshipCountry | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% if subject.formData.citizenshipState and (subject.formData.citizenshipState | trim) %}
                        ,
                        {
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166:-2",
                                "code" : "{{ subject.formData.citizenshipState | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% endif -%}
                        ],
                        {% endif -%}
                        "type": {
                            "coding": {
                            "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                            "code": "PPN"
                            }
                        },
                        "value": "{{ subject.formData.passportNumber | trim }}"
                        }
                    ],
                    {% elif subject.formData.driversLicense and (subject.formData.driversLicense | trim) %}
                    "identifier" : [
                        {
                        {% if subject.formData.citizenshipCountry and (subject.formData.citizenshipCountry | trim) %}
                        "extension" : [{
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166",
                                "code" : "{{ subject.formData.citizenshipCountry | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% if subject.formData.citizenshipState and (subject.formData.citizenshipState | trim) %}
                        ,
                        {
                            "url" : "http://hl7.org/fhir/StructureDefinition/patient-citizenship",
                            "extension" : [{
                            "url" : "code",
                            "valueCodeableConcept" : {
                                "coding" : [{
                                "system" : "urn:iso:std:iso:3166:-2",
                                "code" : "{{ subject.formData.citizenshipState | trim}}"
                                }]
                            }
                            }, 
                            {
                            "url" : "period",
                            "valuePeriod" : {
                                "start" : "{{ credential.createdAt | date('yyyy-MM-DD') }}"
                            }
                            }]
                            }
                        {% endif -%}
                        ],
                        {% endif -%}
                        "type": {
                            "coding": {
                            "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                            "code": "PPN"
                            }
                        },
                        "value": "{{ subject.formData.driversLicense | trim }}"
                        }
                    ],
                    {% endif -%}
                    {% if subject.formData.mobilePhone and (subject.formData.mobilePhone | trim) %}
                    "telecom": [{
                        "system": "phone",
                        "value": "{{ subject.formData.mobilePhone | trim }}",
                        "use": "mobile"
                    }],
                    {% endif -%}
                    {% if subject.formData.birthDate %}
                    "birthDate": "{{ subject.formData.birthDate | date('yyyy-MM-DD') }}",
                    {% endif -%}
                    "name": [{
                        "family": "{{ subject.formData.familyName | trim }}",
                        "given": ["{{ subject.formData.givenName | trim }}"{% if subject.formData.middleName and (subject.formData.middleName | trim) %}, "{{ subject.formData.middleName | trim }}"{% endif %}]
                    }],
                    "gender": "{% if subject.formData.gender and (subject.formData.gender | trim) %}{{ subject.formData.gender | trim }}{% else %}unknown{% endif %}"
                }
            },
            {
                "fullUrl": "https://creds.magnacerta.com/{{ credential.id }}/bundle/resource/immunization/1/dose/1",
                "resource": {
                    "resourceType": "Immunization",
                    "status": "completed",
                    "vaccineCode": {
                    "coding": [
                        {
                        "system": "http://hl7.org/fhir/sid/cvx",
                        "code": "212"
                        }
                    ]
                    },
                    "manufacturer": {
                        "display": "Janssen Pharmaceuticals Companies of Johnson & Johnson"
                    },
                    "patient": {
                        "reference": "https://creds.magnacerta.com/{{ credential.id }}/bundle/resource/0"
                    },
                    "occurrenceDateTime": "{{ subject.formData.ocurrenceDate | date('yyyy-MM-DD') }}",
                    "performer": [
                    {
                        "actor": {
                            "display": "{{ digitalPen.legalName }}"
                        }
                    }
                    ],
                    "lotNumber": "{{ subject.formData.lotNumber}}"
                }
            }
        ]
    }
  }
}
